<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
    <%-- <script type="text/javascript" src="../content/scripts/vnpt-plugin.js"></script>
    <script type="text/javascript" src="../content/scripts/base64.js"></script>
    <script type="text/javascript" src="../content/scripts/SignContractUi.js"></script>--%>

<%--    <link rel="stylesheet" href="../../content/kyso/styles/backend/assets/ca-icon/style.css"
    <link rel="stylesheet" href="../../content/kyso/styles/backend/assets/ap8/css/style.css">
    <link rel="stylesheet" href="../../content/kyso/styles/backend/css/style.css?v+20240416">--%>


    <script type="text/javascript" src="../../content/scripts/jquery-1.8.3.js"></script>

    <link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/asRange.min.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-uis.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdfsignatures.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/wPaint-master/lib/wColorPicker.min.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/wPaint-master/src/wPaint.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/jquery-wizard/jquery-wizard.min.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/dropify/dropify.min.css">
    <link rel="stylesheet" href="../../content/kyso/styles/backend/assets/customsrollbar/scrollBar.css">


    <%--<link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/asrange.min.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-ui.css">
    <link rel="stylesheet" href="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdfsignature.css">--%>
    
    <script type="text/javascript" src="../../content/kyso/styles/backend/assets/jquery/popper.min.js"></script>

<%--    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdfsignature.js"></script>--%>
    <script type="text/javascript" src="../../content/kyso/vendor/babel-external-helpers/babel-external-helpers.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/popper-js/umd/popper.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/bootstrap/bootstrap-notify.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/moment.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/Component.js"></script>

    <script type="text/javascript" src="../../content/kyso/js/Resources/setlanguage.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/Resources/Signature_Resources_vi.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/Resources/Signature_Resources_en.js"></script>

    <script type="text/javascript" src="../../content/kyso/vendor/icheck/icheck.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/dropify/dropify.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/lib/jquery.ui.widget.1.10.3.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/lib/jquery.ui.mouse.1.10.3.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/lib/jquery.ui.core.1.10.3.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/lib/jquery.ui.draggable.1.10.3.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-ui.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-touch.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/lib/wColorPicker.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/src/wPaint.utils.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/src/wPaint.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/wPaint-master/plugins/main/src/wPaint.menu.main.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-asRange.min.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/jscolor.js"></script>
    <%--<script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdf.js-2.6.67/pdf.worker.js"></script>--%>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdf.js-2.6.67/pdf.js"></script>
    
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdfsignature.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/filesize.js"></script>
    <script type="text/javascript" src="../../content/kyso/styles/backend/assets/customsrollbar/scrollBar.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/vnpt-plugin/base64.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/vnpt-plugin/vnpt-plugin.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/jquery-wizard/jquery-wizard.js"></script>
    <script type="text/javascript" src="../../content/kyso/js/signature/signature_multiple_worker.js"></script>


    <%--<script type="text/javascript" src="../../content/kyso/styles/backend/assets/customsrollbar/scrollBar.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdf.js-2.6.67/pdf.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/pdf.js-2.6.67/pdf.worker.js"></script>
    <script type="text/javascript" src="../../content/kyso/vendor/pdfsignature-2.0.0.6/jquery-asRange.min.js"></script>--%>
    <style>
        #kdc-upload{
            display:none
        }
        .signaturebox-textonly::before {
            /*background-image: url("images/default.png");*/
            background-size: contain;
            background-repeat: no-repeat;
            background-position-x: center;
            content: ' ';
            display: block;
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /*z-index: 0;*/
            opacity: 0.4;
        }
        .ui-dialog .ui-dialog-titlebar-close span { display: none; margin: 0px; }
        /*.ui-dialog{
            left: 436px; 
            top: 94px;
        }*/
    </style>
<body>
    <div id="loginvnpt">
       <input class="form-control" id="userName-vnpt" type="text" style="border: 1px solid black; width:100%; margin-bottom:20px" placeholder="Tài khoản VNPT Ca" value=""/>
       <input class="form-control" id="password-vnpt" type="password" style="border: 1px solid black; width:100%; margin-bottom:20px" placeholder="Mật khẩu VNPT Ca" value=""/>
       <button class="form-control" onclick="loginVnptHash()" id="submitVnpt" style="margin-bottom:20px; width:100%">Đăng nhập</button>
    </div>
    <br />
    <div class="row" id="pdf-container" data-plugin="matchHeight" data-by-row="true" style="display: none;">
        <div class="container" id="pdf-advanced">
        </div>
    </div>
    <div id="loading-dialog">
        <div>Loading...</div>
    </div>
<script>
    let base64PDf = "";
    $(document).ready(function () {
        const uiDialogs = $(".ui-dialog")
        for (let i = 0; i < uiDialogs.length; i++) {
            if ($(uiDialogs[i]).attr("aria-describedby") == "divLoading") {
                $(uiDialogs[i]).css("left", $(document).width() / 2 - $(uiDialogs[i]).width() / 2)
                $(uiDialogs[i]).css("top", $(document).height() / 2 - $(uiDialogs[i]).height() / 2)

            }
        }
        const uiDialogClose = $(".ui-dialog-titlebar-close")
        for (let i = 0; i < uiDialogClose.length; i++) {
            $(uiDialogClose[i]).on("click", ()=>{
                openWaitingDialog();
                window.history.back();
                // window.location.href = localStorage.getItem("preUrl")
            })
        }
        $("#userName-vnpt").val(localStorage.getItem("keyUser"));
        $("#password-vnpt").val(localStorage.getItem("keyPass"));
    })

    function showPdfKy(base64, options) {
        $("#pdf-container").css("display", "block");
        let vnptPdf = $("#pdf-advanced").pdfsignature(options);
        //self.vnptPdf.initDataFile(file);
        vnptPdf.initDataBase64(base64);
        vnptPdf.start();
        $("#pdf-container").dialog("open");
    }

    function loginVnptHash() {
        let obj = {
            UserName: $("#userName-vnpt").val(),
            Password: $("#password-vnpt").val()
        }

        openWaitingDialog();
        let userVal = $("#userName-vnpt").val();
        let passVal = $("#password-vnpt").val();
        let user = localStorage.getItem("keyUser");
        let password = localStorage.getItem("keyPass");

        if (!user || user != userVal) {
            localStorage.setItem("keyUser", userVal)
        }
        if (!password || passVal != password) {
            localStorage.setItem("keyPass", passVal)
        }
        $("#loginvnpt").dialog("close");

        $.ajax({
            url: localStorage.getItem("apiLoginVNPT"),
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify({ loginEntityStr: JSON.stringify(obj) }),
            async: true,
        })
            .done(function (res) {
                access_token = res.d.token
                GetBase64RDLC()
                    .done(function (res) {
                        closeWaitingDialog();
                        //displayPDF(res.d);
                        //$("#pdf-viewer").dialog("open");
                        let options = {
                            // Hàm callback khi chọn 'Đồng ý ký'
                            Callback: sign,
                            // Hàm callback khi chọn 'Không đồng ý ký'
                            onReject: null,
                            // Hàm callback khi tạo mới một mẫu chữ ký
                            onCreateSignatureImg: function (evt) {
                                console.log(evt);
                            },
                            // Hàm callback khi xóa một mẫu chữ ký
                            onRemoveSignatureImg: function (evt) {
                                console.log(evt);
                            },
                            // Danh sách mẫu chữ ký
                            signatureImgs: []
                        };
                        base64PDf = res.d
                        showPdfKy(res.d, options);
                        console.log(base64PDf)

                    })
                    .fail(function (res) {
                        // closeWaitingDialog();
                        // showError("Không thể xuất thông báo")
                    })
            })
            .fail(function (err) {
                //showError("Sai tài khoản hoặc mật khẩu")
                closeWaitingDialog();
                window.history.back();
            })
    }

    function GetBase64RDLC() {
        let listObjKey = JSON.parse(localStorage.getItem("listKeyBase64"))
        let listObjValue = JSON.parse(localStorage.getItem("listValueBase64"))
        let obj = {}
        for(let i=0; i<listObjKey.length; i++){
            obj[listObjKey[i]] = JSON.stringify(listObjValue[i])
        }
        return $.ajax({
            url: localStorage.getItem("apiSetBase64"),
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(obj),
            async: true,
        })
    }

    function sign(data) {
        if (!data.imageSrc) {
            alert("Vui lòng chọn chữ ký!");
            return;
        }
        let objDocSignStr = JSON.stringify({
            base64Doc: base64PDf,
            access_token: access_token,
            img: data.imageSrc,
            signatures: data.signatures,
            tenVB: localStorage.getItem("tenVb")
        })

        openWaitingDialog()
        $.ajax({
            url: localStorage.getItem("apiSign"),
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify({ docSignStr: objDocSignStr }),
            async: true,
        })
            .done(function (res) {
                let listKeyLuuLySo = JSON.parse(localStorage.getItem("listKeyLuuKySo"))
                let listValueLuuKySo = JSON.parse(localStorage.getItem("listValueLuuKySo")) 
                listValueLuuKySo[0].Base64Pdf = res.d
                let obj = {}
                for(let i=0; i<listKeyLuuLySo.length; i++){
                    obj[listKeyLuuLySo[i]] = JSON.stringify(listValueLuuKySo[i])
                }
                $.ajax({
                    url: localStorage.getItem("apiLuuKySo"),
                    type: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify(obj),
                    async: true,
                })
                .done(()=>{
                    localStorage.setItem("isKySoSuccess", true)
                    closeWaitingDialog();
                    window.history.back();
                })
                .fail(()=>{
                    alert("Ký số không thành công !")
                    closeWaitingDialog();
                    window.history.back();
                })
                
                
            })
            .fail(function (err) {
                //showError("Lỗi ký số.Vui lòng ký lại")
                closeWaitingDialog()
            })
    }
    function openWaitingDialog(){
        $("#loading-dialog").dialog("open");
    }
    function closeWaitingDialog(){
        $("#loading-dialog").dialog("close");
    }

    $("#loginvnpt").dialog({
        autoOpen: true,
        modal: true,
        width: $(document).width() / 5,
        height: $(document).height() / 5,
        title: "Đăng nhập VNPT CA"
    });
    $("#pdf-container").dialog({
        autoOpen: false,
        modal: true,
        width: $(document).width()/1.1,
        height: $(document).height(),
        title: "Ký số"
    });
    $("#loading-dialog").dialog({
        autoOpen: false,
        modal: true,
        width: $(document).width() / 8,
        height: $(document).height() / 8,
        title: "Loading..."
    });
</script>
</body>
</html>